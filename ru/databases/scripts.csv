name|code
client-connected|function main(...)¡n  client:send('[Место под красивoe приветствие]');¡n  auth(0);¡nend¡n¡nfunction auth(trynum)¡n  if trynum == 0 then¡n    client:send('Введите свой логин или «новый» для создания новой учетной записи:');¡n  elseif trynum < 5 then¡n    client:send("Попытка "..(trynum+1).." из 5. Введите логин: ");¡n  else¡n    client:interrupt();¡n    return;¡n  end¡n  ¡n  local readed = client:read();¡n¡n  if readed == 'новый' then¡n    newprofile();¡n    auth(0);¡n  else¡n    local check = accounting:checkLoginExists(readed);¡n    ¡n    if check then¡n      client:send('Введите пароль: ');¡n      local ln = client:read();¡n      check = client:tryAuth(readed, ln);¡n      ¡n      if check then¡n        username = readed;¡n        mn_menu(0);¡n      else¡n        client:send('Пароль неверен.');¡n        auth(trynum+1);¡n      end¡n      ¡n    else¡n      client:send('Логин не существует.');¡n      auth(trynum+1);¡n    end¡n  end¡nend¡n¡nfunction mn_menu(trynum)¡n  if trynum < 1 then¡n    client:send('Привет, '..username..'!');¡n    client:send('[Место под _важные_ объявления.]');¡n  end¡n  ¡n  local sel = select('Выбрать аватаp','Учетная запись', 'Что-то еще');¡n  ¡n  if sel == 1 then¡n    sel_avatar();¡n  elseif sel == 2 then¡n    client:send('Настройки учетки будут тут![BR]');¡n    mn_menu(trynum+1);¡n  elseif sel == 3 then¡n    client:send('Разное будет тут![BR]');¡n    mn_menu(trynum+1);¡n  else¡n    client:send('Это БАГ! Так и скажи iillyyaa2033.[BR]');¡n    mn_menu(trynum+1);¡n  end¡nend¡n¡nfunction sel_avatar(...)¡n  client:doAvatarSelection();¡n  ¡n  client:send('=========');¡n  client:openGame();¡nend¡n¡nfunction newprofile(...)¡n  local name = np_name(0);¡n  local pwd = np_pwd();¡n  ¡n  accounting:addAccount(name,pwd);¡n  client:send('Учетная запись создана!');¡nend¡n¡nfunction np_name(trynum)¡n  if trynum == 0 then¡n    client:send('Введите желаемый логин:');¡n  else¡n    client:send("Попробуйте еще раз:");¡n  end¡n  ¡n  local name = client:read();¡n  local ex = accounting:checkLoginExists(name);¡n  ¡n  if ex then¡n    client:send('Логин занят!');¡n    return npname(trynum+1);¡n  else¡n    client:send('Теперь введите логин повторно - для проверки:');¡n    local rename = client:read();¡n    if name == rename then¡n      return name;¡n    else¡n      client:send('Логины не совпали!');¡n      return npname(trynum+1);¡n    end¡n  end¡nend¡n¡nfunction np_pwd()¡n  client:send('Введите пароль: ');¡n  local pwd = client:read();¡n  client:send("Повторите пароль: ");¡n  local cpwd = client:read();¡n  ¡n  if pwd == cpwd then¡n    return pwd;¡n  else¡n    client:send('Пароли не совпали. Попробуйте еще раз.');¡n    return nppwd();¡n  end¡nend¡n¡nfunction np_history()¡n¡nend¡n¡n¡nfunction select(...)¡n  if #arg == 0 then¡n    return -1;¡n  else¡n    for i = 1, arg.n do¡n      arg[i] = i..'. '..arg[i];¡n      client:send(arg[i]);¡n    end¡n    ¡n    local correct = -1;¡n    ¡n    while correct < 0 do¡n      local readed = client:read();¡n      ¡n      for j = 1, arg.n do¡n        local found = string.find(arg[j],readed);¡n        if found ~= nil then ¡n          correct = j;¡n        end¡n      end¡n      ¡n      if correct < 0 then¡n        client:send('Попробуйте еще раз.');¡n      end¡n    end¡n    ¡n    return correct;¡n  end¡nend¡n
